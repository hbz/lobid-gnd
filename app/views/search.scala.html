@(q: String, f: String, from: Int, size: Int, result: String, allHits: Long)

@import play.api.libs.json._
@import controllers.HomeController.CONFIG

@pagination(hits:Int)={
  <nav>
    <ul class="pagination">
      <li class="previous @if(from==0){disabled}">
        <a href="@if(from==0){#} else {@routes.HomeController.search(q,f,from-size,size,"html")}">&larr;</a>
      </li>
      @defining((((from+1)/size)+1,(if(allHits%size==0) allHits/size else allHits/size+1).toInt)) { case (currentPage,lastPage) =>
          @defining(Math.min(Math.max(1,currentPage-4)+9,lastPage)) { toPage =>
              @for(i <- Math.max(1,toPage-9) to toPage){
                  <li @if(currentPage==i){class="active"}><a href="@routes.HomeController.search(q,f,(i*size)-size,size,"html")">@i</a></li>
              }
          }
      }
      <li class="next @if(from+size >= allHits){disabled}">
        <a href="@if(from+size >= allHits){#} else {@routes.HomeController.search(q,f,from+size,size,"html")}">&rarr;</a>
      </li>
    </ul>
  </nav>
 }

@pageLink(num: Int)={
<li @if(size==num){class="active"}>
  <a href="@routes.HomeController.search(q,f,from,num,"html")">@num</a>
</li>
}

@icons(t: String) = @{controllers.HomeController.configNested("icons", t)}

@iconFor(types: Seq[String]) = {
	@for(t <- types; icon = icons(t); if icon != null) {
		@icon
	}
}

@typesFor(doc: JsValue) = @{
	(doc \ "type").as[Seq[String]].filter(_!="AuthorityResource").mkString(", ")
}

@result_short(id:String, doc: play.api.libs.json.JsValue, i: Int = -1) = {
    <tr>
        <td><i class='@iconFor((doc \ "type").as[Seq[String]])' aria-hidden='true' title='@typesFor(doc)'></i></td>
        <td class='text-left'><a href='@routes.HomeController.authority(id)'>@((doc \ "preferredName").asOpt[String].getOrElse(""))</a></td>
        <td class='text-right'>@((doc \ "variantName").asOpt[Seq[String]].getOrElse(Seq()).take(3).mkString("; "))</td>
        <td class='text-right'><a href='@((doc \ "id").asOpt[String].getOrElse(""))' title='DNB-Link'>@((doc \ "gndIdentifier").asOpt[Seq[String]].getOrElse(Seq()).take(1))</td>
    </tr>
}

@facetLink(key: String, term: String, count: Int) = {
	@if(f.contains(key+":"+term)){
		@term
		<a href='@routes.HomeController.search(q, f.replace(s"+($key:$term)", "").replace(s"$key:$term","").trim, from, size)'>
		<span class="badge">Filter entfernen <span class="glyphicon glyphicon-remove"></span></span>
		</a>
	} else {
		<a href='@routes.HomeController.search(q, s"$f +($key:$term)".trim, from, size)'>@term (@count)</a>
	}
	<br/>
}

@facetLinks(buckets: Seq[JsValue], key: String = "type") = { 
	@defining(buckets.groupBy((bucket:JsValue) => HomeController.configNested("types",(bucket \ "key").as[String]))) { grouped =>
		@for(
				(bucket, bIndex) <- grouped.get(null).getOrElse(Seq()).zipWithIndex;
				term = (bucket \ "key").as[String];
				count = (bucket \ "doc_count").as[Int]) {
			<p>
			<i class='@iconFor(Seq(term))' aria-hidden='true' title='@term'></i>
			@facetLink(key, term, count)
			@defining(grouped.get(term).getOrElse(Seq()).zipWithIndex) { subs =>
				@for(
						(sub, sIndex) <- subs;
						subTerm  = (sub \ "key").as[String];
						subCount = (sub \ "doc_count").as[Int]){
					<span @if(sIndex > 2){style="display:none" class="@bIndex-more-item"}>
						&rdsh;&nbsp; @facetLink(key, subTerm, subCount)
					</span>
				}
				@if(subs.size>3){
					<a id="@bIndex-more-link" href="javascript:void(0)" 
							onclick="$('.@bIndex-more-item').show(); $('#@bIndex-more-link').hide(); $('#@bIndex-less-link').show();">
						<span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Mehr Untertypen anzeigen<br/>
					</a>
					<a id="@bIndex-less-link" href="javascript:void(0)" style="display:none"
							onclick="$('.@bIndex-more-item').hide(); $('#@bIndex-more-link').show(); $('#@bIndex-less-link').hide();">
						<span class="glyphicon glyphicon-minus" aria-hidden="true"></span> Weniger Untertypen anzeigen<br/>
					</a>
				}
			}
			</p>
		}
	}
}

@main(q, "lobid-gnd - search") {
  <!-- <code><pre>@result</pre></code>  -->
  @defining((Json.parse(result) \ "member").asOpt[Seq[JsValue]].getOrElse(Seq()).zipWithIndex) { hits =>
     <div class="row" id="search-results">
         <div class="col-md-@if(allHits > 0){8}else{12}">
         @if(hits.size>0){
             <div class="row hide-in-print" >
                 <div class="col-md-12">
                   <ul class="nav nav-pills" style="display:inline-block" role="tablist">
                     <li class="disabled">  <a href="#">Treffer pro Seite:</a> </li>
                     @pageLink(10)
                     @pageLink(20)
                     @pageLink(50)
                     @pageLink(100)
                   </ul>
                 </div>
             </div>
             <p/>
             <div class="panel panel-default">
                 <div class="panel-body text-center">
                 <div class="row">
                    <!-- <div class="col-md-1"></div>  -->
                    <div class="col-md-12">
                     @allHits Treffer, zeige @(from+1) bis @(Math.min(from+hits.size,from+size)):
                    </div>
                 </div>
                 </div>
                 <table class="table table-striped table-condensed">
                 @for((doc,i) <- hits; id = (doc\"gndIdentifier")(0).as[String]) {
                    @result_short(id,doc,i-1)
                 }
                 </table>
                 <div class="panel-body hide-in-print text-center">
                     @pagination(hits.size)
                 </div>
             </div>
         }
         @if(flash.get("error")!=null && hits.isEmpty){
            <div class="alert alert-danger text-center">@Html(flash.get("error"))</div>
         } else {
           @if(flash.get("warning")!=null && hits.isEmpty){
             <div class="alert alert-warning text-center">@Html(flash.get("warning"))</div>
           } else {
             @if(hits.isEmpty){
               <div class="alert alert-info text-center">
                 Keine Ergebnisse. Suchoptionen: Begriffe <code>+</code>einschließen, <code>-</code>ausschließen, unscharf<code>~</code>, <code>"</code>exakt suchen<code>"</code>.
               </div>
             }
           }
         }
        </div>
        <div class="col-md-4" id="facets">
			<p>
				@defining(("type", (Json.parse(result) \ "aggregation" \ "type").asOpt[Seq[JsValue]].getOrElse(Seq()))) { case (jsKey, buckets) => 
					@if(!buckets.isEmpty) {
						<h4>Ergebnisse eingrenzen:</h4>
						@facetLinks(buckets)
					}
				}
			</p>
		</div>
      </div>
  }

}