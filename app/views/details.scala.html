@* Copyright 2015-2018 Fabian Steeg, hbz. Licensed under the EPL 2.0 *@

@(resource: models.AuthorityResource)

@import play.api.libs.json._

@image() = {
    <img src='https://lobid.org/imagesproxy?url=@resource.getImage.image' style="max-height:500px;" class="center-block" alt="@resource.preferredName"/>
    <div class='text-center small'><br/>@Html(resource.getImage.label)</div>
}

@moreToggle(field: String, value: String) = {
    @if(value.contains(field+"-hide-by-default")) {
        <a id='@field-more' title='Mehr anzeigen' href='javascript:void(0)' 
                onclick='$("#@field-hide-by-default").show(); $("#@field-more").hide(); $("#@field-less").show();'>
            <span class="octicon octicon-diff-added" aria-hidden="true"></span>
        </a>
        <a id='@field-less' style='display: none;' title='Weniger anzeigen' href='javascript:void(0)' 
                onclick='$("#@field-hide-by-default").hide(); $("#@field-less").hide(); $("#@field-more").show();'>
            <span class="octicon octicon-diff-removed" aria-hidden="true"></span>
        </a>
    }
}

@graph() = {
  <script type="text/javascript" src='@controllers.routes.Assets.versioned("javascripts/vis.js")'></script>
  <link href='@controllers.routes.Assets.versioned("stylesheets/vis-network.min.css")' rel="stylesheet" type="text/css" />
  <style type="text/css">
    #gnd-network {
      width: 100%;
      height: 500px;
      border: 1px solid lightgray;
    }
  </style>
  <div id="gnd-network"></div>
  <script type="text/javascript">
    function changeCursor(cursor) {
      var networkCanvas = document.getElementById("gnd-network").getElementsByTagName("canvas")[0]
      networkCanvas.style.cursor = cursor;
    }
    function valid(t, regex) {
      if(!t) return false;
      var match = t.match(regex);
      return match && match[0].length == t.length;
    }
    function validTarget(target) {
      return valid(target, /^\d.*/);
    }
    function validEdge(edge) {
      return valid(edge, /[a-zA-Z]+/);
    }
    var container = document.getElementById('gnd-network');
    var data = {
      nodes: new vis.DataSet(@Html(resource.gndRelationNodes())),
      edges: new vis.DataSet(@Html(resource.gndRelationEdges()))
    };
    var options = {
      interaction: {
        hover: true,
        navigationButtons: true,
        keyboard: false
      },
      edges:{ chosen: false },
      layout: { randomSeed: 2 },
      physics: {
        forceAtlas2Based: {
          springLength: 75,
          centralGravity: 0.015,
          avoidOverlap: 1
        },
        solver: "forceAtlas2Based",
        stabilization: { enabled: true }
      }
    };
    var network = new vis.Network(container, data, options);
    $('.vis-button').hide();
    $('.vis-zoomIn').show();
    $('.vis-zoomOut').show();
    network.selectNodes(['@resource.getId'], false);
    network.on("stabilizationIterationsDone", function () {
      network.setOptions( { physics: false } );
      changeCursor('grab');
    });
    network.on("click", function (params) {
      var target = this.getNodeAt(params.pointer.DOM);
      if(validTarget(target)) {
        window.location.href = target+"#rels";
      } else {
        var edge = params.edges[0].split("_");
        var rel = edge[0];
        var to = edge[1];
        if(validEdge(rel)){
          var q = '"' + '@models.AuthorityResource.GND_PREFIX' + to + '"';
          var search = "/gnd/search?q=" + rel + ".id:" + q;
          window.location.href = search;
        }
      }
    });
    network.on("hoverNode", function (params) {
      var target = this.getNodeAt(params.pointer.DOM);
      if(validTarget(target)) {
        changeCursor('pointer');
      }
    });
    network.on('blurNode', function () {
      changeCursor('grab');
    });
    network.on("hoverEdge", function (params) {
      var edge = this.getEdgeAt(params.pointer.DOM).split("_")[0];
      if(validEdge(edge)){
        changeCursor('pointer');
      }
    });
    network.on('blurEdge', function () {
      changeCursor('grab');
    });
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      network.fit();
    });
    var anchor = window.location.href.split('#')[1];
    if(anchor){
      $('.nav li a').filter('[href="#'+anchor+'"]').tab('show');
    }
  </script>
}

@map() = {
 <link rel="stylesheet" href='@controllers.routes.Assets.versioned("stylesheets/leaflet.css")' />
 <script src='@controllers.routes.Assets.versioned("javascripts/leaflet.js")'></script>
 <div id="authority-map" class="authority-map"></div>
 <script async type='text/javascript'>
   var layer = L.tileLayer('https://lobid.org/tiles/{z}/{x}/{y}.png', {
     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
   });
   var center = new L.LatLng(@resource.location.getLat, @resource.location.getLon)
   var map = new L.Map("authority-map", {
    center: center,
    zoom: @if(resource.getType.contains("Country")) {3} else {@if(resource.getType.contains("MemberState")) {5} else {10}},
    maxZoom: 17,
    scrollWheelZoom: true,
    attributionControl: true,
    zoomControl: true
   });
   var marker = L.marker(center,{
     title: '@resource.title'
   });
   marker.addTo(map);
   map.addLayer(layer);
 </script>
}

@dataSource() = { @defining(resource.sameAs.size>3 || !resource.depiction.isEmpty) { entityFacts =>
<p><div class="text-center small">
  Datenquelle@if(entityFacts){n}: DNB <a href='https://www.dnb.de/lds'>Linked-Data-Service</a>
  (<a title='RDF/XML aus GND anzeigen' href='https://d-nb.info/gnd/@resource.getId()/about/lds.rdf'>RDF/XML</a>, 
  <a title='Turtle aus GND anzeigen' href='https://d-nb.info/gnd/@resource.getId()/about/lds.ttl'>Turtle</a>)
  @if(entityFacts){und <a href='https://www.dnb.de/entityfacts'>Entity Facts</a> (<a title="JSON-LD in Entity Facts anzeigen" href='@(controllers.HomeController.config("entityfacts.live")+resource.getId)'>JSON-LD</a>)}
  | <a href='https://creativecommons.org/publicdomain/zero/1.0/'>CC0</a>
</div></p>
}}

@fields() = {
<script type="text/javascript">
    function result(string, link, res) {
        if(res) {
            link.trigger('copied', ['Kopiert: ' + string]);
        }
        return res;
    }
    function copyToClipboard(string, link, msg) {
        link.bind('copied', function(event, message) {
            $(this)
                .attr('title', message).tooltip('fixTitle').tooltip('show')
                .attr('title', msg).tooltip('fixTitle');
        });
        if (window.clipboardData && window.clipboardData.setData) {
            return result(string, link, clipboardData.setData("Text", string));
        } else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
            var temp = document.createElement("textarea");
            temp.textContent = string;
            temp.style.position = "fixed";
            document.body.appendChild(temp);
            temp.select();
            try {
                return result(string, link, document.execCommand("copy"));
            } catch (ex) {
                console.warn("Copy to clipboard failed.", ex);
                window.prompt("Kopieren: Strg+C, Enter", string);
            } finally {
                document.body.removeChild(temp);
            }
        }
    }
    $(function() { $('[data-toggle="tooltip"]').tooltip(); });
</script>
<table class='table table-striped table-condensed'>
  <tr>
    <td>URI</td> @defining((AuthorityResource.GND_PREFIX + resource.getId(), "URI in die Zwischenablage kopieren")) { case (uri, title) =>
    <td class='field-value'>@uri
            <a data-toggle="tooltip" data-placement="right" title="@title" href="#" onclick="copyToClipboard('@(uri)', $(this), '@title'); return false;">
                <span class="octicon octicon-clippy"></span>
            </a>
    }
    </td>
  </tr>
  @for(f <- resource.generalFields) {
    <tr><td>@models.GndOntology.label(f.getLeft).replace(" (Literal)", "")</td><td class='field-value'>@Html(f.getRight) @moreToggle(f.getLeft, f.getRight)</td></tr>
  }
  @for(f <- resource.additionalLinks) {
    <tr><td>@models.GndOntology.label(f.getLeft).replace(" (Literal)", "")</td><td class='field-value'>@Html(f.getRight) @moreToggle(f.getLeft, f.getRight)</td></tr>
  }
</table>
}

@leftWidth() = @{
  if(resource.getImage.image.isEmpty && resource.location == null) {12} else {8}
}

@if(resource == null){
  @main("", "lobid-gnd") {
    <div id="search-results" class="alert alert-info text-center">Ein Titel mit der ID @request.uri.toString.split("/").last konnte nicht gefunden werden.</div>
  }
} else {
@main("", resource.preferredName) {
    <div class="page-header">
        <h1>
            @defining("Namen in die Zwischenablage kopieren") { title =>
            <a class="invisible-link" data-toggle="tooltip" data-placement="right" title="@title" href="#" onclick="copyToClipboard('@(resource.title)', $(this), '@title'); return false;">
                @resource.title
            </a>
            }
            <small>
            @for(t <- resource.getType){
                <sup>
                  <small>
                    <span class='label label-primary'><a href='@routes.HomeController.search(q="type:"+t)'>@models.GndOntology.label(t)</a></span>
                  </small>
                </sup> 
            }
            <div class='pull-right'>
                <a title="JSON-LD-Indexdaten anzeigen" href='@routes.HomeController.authorityDotFormat(resource.getId, "json")'>
                <img class='json-ld-icon' src='@routes.Assets.versioned("images/json-ld.png")' alt='JSON'/></a>
            </div>
            <br/>@Html(resource.subTitle)
            </small>
        </h1>
    </div>
    @if(resource.getType.contains("DifferentiatedPerson") && resource.getBirthYear > 1940){
    <div id="meta-person" class="alert alert-info">
      <h3>Sind Sie @resource.preferredName ? Klicken Sie hier.</h3>
      <div>
        <p>
          Bei dieser Seite handelt es sich um eine Sicht des Eintrags zu Ihrer Person in der Gemeinsamen Normdatei (GND). 
          Die GND unterstützt die Katalogisierung in Gedächtnisinstitutionen (Bibliotheken, Archiven und Museen) und 
          dient der eindeutigen Identifizierung von Urheber:innen, um die veröffentlichten Werke von einer Person zu bündeln. 
          Ein GND-Eintrag zu einer Person wird etwa angelegt, wenn eine Gedächtnisinstitution zum ersten Mal eine Publikation 
          (Dissertation o.ä.) einer Person in ihrem Katalog erfasst.
        </p>
        <p>
          Die Informationen in einem Normdatensatz werden ausschließlich aus öffentlich zugänglichen Quellen gespeist, 
          Fehler oder Unvollständigkeiten sind nicht ausgeschlossen. 
          Falls Sie Fehler melden möchten oder mit der Veröffentlichung bestimmter Informationen nicht einverstanden sind, 
          wenden Sie sich an <a href="mailto:gnd-redaktion@@hbz-nrw.de">gnd-redaktion@@hbz-nrw.de</a>
        </p>
      </div>
    </div>
    <script type="text/javascript">
      $( function() {
        $( "#meta-person" ).accordion({
          collapsible: true,
          active: false,
          heightStyle: "content"
        });
      } );
    </script>
    }
    @if(resource.gndRelationEdges != "[]"){
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="active"><a href="#fields" role="tab" data-toggle="tab">Felder</a></li>
      @if(resource.gndRelationEdges != "[]"){<li role="presentation"><a href="#rels" role="tab" data-toggle="tab">Beziehungen</a></li>}
    </ul>
    }
    <div class="row">
        <div class="tab-content">
            <div role="tabpanel" id="fields" class="tab-pane active col-md-@leftWidth intro">
                @fields
                @dataSource
            </div>
            <div  role="tabpanel" id="rels" class="tab-pane col-md-@leftWidth intro">
                @if(resource.gndRelationEdges != "[]") {
                    @graph()
                }
                @dataSource
            </div>
        </div>
        <div class="col-md-@(12-leftWidth) intro">
            @if(resource.location != null) {
                @map()
            }
            @if(!resource.getImage.image.isEmpty){
                @image()
            }
        </div>
    </div>
}
}
